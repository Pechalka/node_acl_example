<!DOCTYPE html>
<html class="no-js" lang="ru"> 
<head>
    <meta charset="utf-8">
    <title>Hello world</title>

<link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="libs/jquery-latest.js" type="text/javascript"></script>
    <script src="libs/knockout/knockout-min.js" type="text/javascript"></script>
   <script src="libs/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

<!-- 

    <script src="libs/knockout/knockout.mapping.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">
 
 -->
    <script type="text/javascript">
    var EditPermisionViewModel = function(close, role, all_resources, isNew){
            var self = this;
            self.isNew = isNew;
            self.title = isNew ? 'Edit role ' + role.name : 'Add new role';
                       
            self.name = ko.observable(role.name);
            self.permissions = ko.utils.arrayMap(all_resources, function(r){

                var i = ko.utils.arrayFirst(role.resources, function(x) { return x == r; });
                var exist = i != null;

                return { path : r, exist : exist}
            });


            self.save = function(){
                var resources = ko.utils.arrayFilter(self.permissions, function(x){ return x.exist; });
                resources = ko.utils.arrayMap(resources, function(x) { return x.path; });
            
                var data = { 
                    name : self.name(),
                    resources : ko.toJS(resources)
                }
                if (self.isNew){
                    $.post('/create_role', data, close);
                } else {
                    $.post('/update_role', data, close);
                }
            }

            self.cansel = function(){
                close();
            }

            self.template = 'edit-permision-modal';
        };

    var EditUsersViewModal = function(close, role){
        var self = this;
        self.name = role.name;

        self.save = function(){

            close();
        }

        self.cansel = function(){
            close();
        }

        self.template = 'edit-users-modal';
    };    

    $(function() {
        var $popup = $('#popup');
            

        var Page = function(model){
            var self = this;
            self.roles = ko.observableArray([]);

            self.popup = ko.observable(null);

            self.all_rotes = null;

            var get_rotes = function(){
                if (!self.all_rotes) return [];

                var routes = ko.utils.arrayMap(self.all_rotes.get, function(x){
                    return  x.path; //x.method + ' ' +
                });

                return routes;
            };

            self.run = function(){
                $.get('/roles', function(data){
                    ko.utils.arrayForEach(data.roles, function(r){
                        if (!r.permissions)
                            r.permissions = [];
                    });
                    self.roles(data.roles);
                    self.all_rotes  = data.all_rotes;
                });
            }

            self.add_role = function(){
                var on_close = function(role){
                    $popup.modal('hide');
                    self.popup(null);
                    if (role) self.roles.push(role);
                };
                self.popup(new EditPermisionViewModel(on_close, { name : '' }, get_rotes(), true));
                $popup.modal('show');
            }

            self.delete_role = function(item){
                $.post('/delete_role', { name : item.name }, function(){
                    self.roles.remove(item);
                });
            }

            self.edit_permissions = function(item){
                var on_close = function(){
                    $popup.modal('hide');
                    self.popup(null);    
                };
                self.popup(new EditPermisionViewModel(on_close, item, get_rotes(), false));
                $popup.modal('show');
            }

            self.edit_users = function(item){
                var on_close = function(){
                    $popup.modal('hide');
                    self.popup(null);    
                };
                self.popup(new EditUsersViewModal(on_close, item));
                $popup.modal('show');
            }
        };

         var vm = new Page();

         ko.applyBindings(vm);

         vm.run();
    });
    </script>

</head>
 <body>
<script type="text/html" id="edit-permision-modal">
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3 data-bind="text : title"></h3>
  </div>
  <div class="modal-body">
    <input type="text" placeholder="role name" data-bind="value : name, enable : isNew" />
    <ul class="inline well" data-bind="foreach : permissions">
        <li>
            <label class="checkbox"  >
                <input type="checkbox" data-bind="checked : exist" />
                <label data-bind="text : path"></label>
            </label>
        </li> 
    </ul>   
    </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-bind="click : cansel">Close</a>
    <a href="#" class="btn btn-primary" data-bind="click : save" >Save changes</a>
  </div>
</script>

<script type="text/html" id="edit-users-modal">
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3 data-bind="text : 'Add/Remove users from role ' + name "></h3>
  </div>
  <div class="modal-body">
    <div class="well"></div>  
    </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-bind="click : cansel">Close</a>
    <a href="#" class="btn btn-primary" data-bind="click : save" >Save changes</a>
  </div> 
</script>

<div class="container">
    <div class="row">
        <div class="span7">
    <ul class="unstyled " data-bind="foreach : roles">
        <li>
            <span data-bind="text : name" class="span4"></span>
            <div class="btn-toolbar">
            <div class="btn-group">
                <a href="javascript:void(0)" class="btn btn-mini" data-bind="click : $parent.edit_permissions">edit permision</a>
                <a href="javascript:void(0)" class="btn btn-mini" data-bind="click : $parent.edit_users">edit users</a>
                <button class="btn btn-mini" data-bind="click : $parent.delete_role">delete role</button>            
            </div>
            </div>
            <!-- <hr/> -->
        </li>
    </ul>
     <a href="javascript:void(0)" class="btn" data-bind="click : add_role">add role</a>
     </div>
    </div>
    <div class="modal hide fade" id="popup" data-bind="with : popup">
        <!-- ko template : { name : template  } -->
        <!-- /ko -->
    </div>
    
</div> 
 </html>
